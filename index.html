<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>調堂工具</title>
    <style>
        body {
            font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            margin: 20px;
            background-color: #f5f5f5;
            background-image: url('https://i.ibb.co/MycJHMJG/image.png');
            background-size: cover;
            background-repeat: no-repeat;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            opacity: 0.87;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
            color: #555;
        }
        select, input[type="file"] {
            padding: 5px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
        }
        #result h2, #scheduleTable h2 {
            color: #333;
            font-size: 18px;
        }
        #result table, #scheduleTable table {
            width: 100%;
            border-collapse: collapse;
        }
        #result th, #result td, #scheduleTable th, #scheduleTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            width: 50px;
            height: 30px;
            min-width: 50px;
            min-height: 30px;
        }
        #result th, #scheduleTable th {
            background-color: #f2f2f2;
        }
        #scheduleTable {
            margin-top: 20px;
            overflow-x: auto;
        }
        .double-border {
            border-left: 3px double #000;
        }
        .copyright-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 5px 10px;
            background-color: #f1f1f1;
        }
        .copyright-footer p {
            margin: 0;
            font-size: 14px;
        }
        @media (max-width: 600px) {
            .copyright-footer p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>調堂工具</h1>
        <div class="form-group">
            <input type="file" id="upload" accept=".xlsx, .xls">
        </div>
        <form id="inputForm">
            <div class="form-group">
                <label for="borrowTeacher">借入老師：</label>
                <select id="borrowTeacher"></select>
            </div>
            <div class="form-group">
                <label for="lendTeacher">借出老師：</label>
                <select id="lendTeacher"></select>
            </div>
            <div class="form-group">
                <label for="className">班別：</label>
                <select id="className"></select>
            </div>
            <div class="form-group">
                <label for="borrowDay">上課日：</label>
                <select id="borrowDay"></select>
            </div>
            <div class="form-group">
                <label for="borrowPeriod">借用課節：</label>
                <select id="borrowPeriod" multiple></select>
            </div>
            <div class="form-group">
                <button type="button" id="submit">提交</button>
            </div>
        </form>
        <div id="scheduleTable"></div>
        <div id="result"></div>
    </div>
    <footer class="copyright-footer">
        <p>Copyright © 2025 陳冠健. All rights reserved.</p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                      row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                      headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        let workbook;
        let teachers = [];
        let classes = new Set();

        document.getElementById('upload').addEventListener('change', handleFile);
        document.getElementById('submit').addEventListener('click', processData);
        document.getElementById('borrowTeacher').addEventListener('change', updateClassesAndSchedules);
        document.getElementById('lendTeacher').addEventListener('change', updateClassesAndSchedules);
        document.getElementById('className').addEventListener('change', updateBorrowDays);
        document.getElementById('borrowDay').addEventListener('change', updateBorrowPeriods);

        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, {type: 'array'});
                populateTeachersAndClasses();
            };
            reader.readAsArrayBuffer(file);
        }

        function populateTeachersAndClasses() {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            
            for (let row = 5; row <= range.e.r; row++) {
                const teacherCell = sheet[XLSX.utils.encode_cell({c: 1, r: row})];
                if (teacherCell && teacherCell.v) {
                    teachers.push(teacherCell.v);
                }
            }

            const borrowTeacherSelect = document.getElementById('borrowTeacher');
            const lendTeacherSelect = document.getElementById('lendTeacher');
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.text = teacher;
                borrowTeacherSelect.add(option.cloneNode(true));
                lendTeacherSelect.add(option);
            });
        }

        function updateClassesAndSchedules() {
            const borrowTeacher = document.getElementById('borrowTeacher').value;
            const lendTeacher = document.getElementById('lendTeacher').value;
            if (!borrowTeacher || !lendTeacher) return;

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const borrowTeacherRow = findTeacherRow(borrowTeacher);
            const lendTeacherRow = findTeacherRow(lendTeacher);

            const borrowClasses = new Set();
            const lendClasses = new Set();

            for (let col = 2; col <= 61; col++) {
                const borrowCell = sheet[XLSX.utils.encode_cell({c: col, r: borrowTeacherRow})];
                const lendCell = sheet[XLSX.utils.encode_cell({c: col, r: lendTeacherRow})];
                if (borrowCell && borrowCell.v) borrowClasses.add(borrowCell.v);
                if (lendCell && lendCell.v) lendClasses.add(lendCell.v);
            }

            const commonClasses = [...borrowClasses].filter(c => lendClasses.has(c)).sort();
            const classSelect = document.getElementById('className');
            classSelect.innerHTML = '';
            commonClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.text = className;
                classSelect.add(option);
            });

            displaySchedules(borrowTeacher, lendTeacher, borrowTeacherRow, lendTeacherRow);
            updateBorrowDays();
        }

        function displaySchedules(borrowTeacher, lendTeacher, borrowTeacherRow, lendTeacherRow) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let html = '<h2>老師課表</h2><table><tr><th>老師</th>';
            for (let day = 1; day <= 6; day++) {
                html += `<th colspan="10">DAY${day}</th>`;
            }
            html += '</tr>';

            html += `<tr><td>${borrowTeacher}</td>`;
            for (let day = 1; day <= 6; day++) {
                for (let period = 1; period <= 10; period++) {
                    const column = getColumnForDayAndPeriod(day, period);
                    const borrowCell = sheet[XLSX.utils.encode_cell({c: column, r: borrowTeacherRow})];
                    const borrowClass = borrowCell ? borrowCell.v : '';
                    html += `<td>${borrowClass}</td>`;
                }
            }
            html += '</tr>';

            html += `<tr><td>${lendTeacher}</td>`;
            for (let day = 1; day <= 6; day++) {
                for (let period = 1; period <= 10; period++) {
                    const column = getColumnForDayAndPeriod(day, period);
                    const lendCell = sheet[XLSX.utils.encode_cell({c: column, r: lendTeacherRow})];
                    const lendClass = lendCell ? lendCell.v : '';
                    html += `<td>${lendClass}</td>`;
                }
            }
            html += '</tr></table>';

            document.getElementById('scheduleTable').innerHTML = html;
        }

        function updateBorrowDays() {
            const lendTeacher = document.getElementById('lendTeacher').value;
            const className = document.getElementById('className').value;
            if (!lendTeacher || !className) return;

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const lendTeacherRow = findTeacherRow(lendTeacher);

            const borrowDaySelect = document.getElementById('borrowDay');
            borrowDaySelect.innerHTML = '';

            for (let day = 1; day <= 6; day++) {
                let hasBorrowPeriod = false;
                for (let period = 1; period <= 10; period++) {
                    const column = getColumnForDayAndPeriod(day, period);
                    const lendCell = sheet[XLSX.utils.encode_cell({c: column, r: lendTeacherRow})];
                    if (lendCell && lendCell.v === className) {
                        hasBorrowPeriod = true;
                        break;
                    }
                }
                if (hasBorrowPeriod) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.text = `DAY${day}`;
                    borrowDaySelect.add(option);
                }
            }

            if (borrowDaySelect.options.length > 0) {
                borrowDaySelect.selectedIndex = 0;
                updateBorrowPeriods();
            } else {
                document.getElementById('borrowPeriod').innerHTML = '';
            }
        }

        function updateBorrowPeriods() {
            const borrowDay = document.getElementById('borrowDay').value;
            const lendTeacher = document.getElementById('lendTeacher').value;
            const className = document.getElementById('className').value;
            if (!borrowDay || !lendTeacher || !className) return;

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const lendTeacherRow = findTeacherRow(lendTeacher);

            const borrowPeriodSelect = document.getElementById('borrowPeriod');
            borrowPeriodSelect.innerHTML = '';

            for (let period = 1; period <= 10; period++) {
                const column = getColumnForDayAndPeriod(borrowDay, period);
                const lendCell = sheet[XLSX.utils.encode_cell({c: column, r: lendTeacherRow})];
                if (lendCell && lendCell.v === className) {
                    const option = document.createElement('option');
                    option.value = period;
                    option.text = `第${period}節`;
                    borrowPeriodSelect.add(option);
                }
            }
        }

        function processData() {
            const borrowTeacher = document.getElementById('borrowTeacher').value;
            const lendTeacher = document.getElementById('lendTeacher').value;
            const className = document.getElementById('className').value;
            const borrowDay = parseInt(document.getElementById('borrowDay').value);
            const borrowPeriods = Array.from(document.getElementById('borrowPeriod').selectedOptions).map(option => parseInt(option.value));

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const lendTeacherRow = findTeacherRow(lendTeacher);
            const borrowTeacherRow = findTeacherRow(borrowTeacher);

            if (lendTeacherRow === -1 || borrowTeacherRow === -1) {
                document.getElementById('result').innerText = '老師未找到';
                return;
            }

            let borrowDetails = [];
            borrowPeriods.forEach(period => {
                const column = getColumnForDayAndPeriod(borrowDay, period);
                const lendCell = sheet[XLSX.utils.encode_cell({c: column, r: lendTeacherRow})];
                if (lendCell && lendCell.v === className) {
                    borrowDetails.push({day: borrowDay, period});
                }
            });

            if (borrowDetails.length === 0) {
                document.getElementById('result').innerText = '借用課節不符指定的班別';
                return;
            }

            const availablePeriods = [];
            for (let day = 1; day <= 6; day++) {
                for (let period = 1; period <= 10; period++) {
                    const column = getColumnForDayAndPeriod(day, period);
                    const borrowCell = sheet[XLSX.utils.encode_cell({c: column, r: borrowTeacherRow})];
                    const lendCellCheck = sheet[XLSX.utils.encode_cell({c: column, r: lendTeacherRow})];
                    if (borrowCell && borrowCell.v === className && (!lendCellCheck || !lendCellCheck.v)) {
                        availablePeriods.push({day, period});
                    }
                }
            }

            const combinedPeriods = generateAllCombinations(availablePeriods, borrowDetails.length, borrowDetails);
            displayResult(borrowDetails, combinedPeriods, borrowTeacher, lendTeacher, className);
        }

        function generateAllCombinations(periods, borrowCount, borrowDetails) {
            periods.sort((a, b) => a.day - b.day || a.period - b.period);
            const combinations = [];
            const isBorrowDouble = borrowCount === 2 && borrowDetails[0].day === borrowDetails[1].day && borrowDetails[0].period + 1 === borrowDetails[1].period;

            if (borrowCount === 1) {
                periods.forEach(p => combinations.push([{day: p.day, periods: [p.period]}]));
            } else if (borrowCount === 2) {
                if (isBorrowDouble) {
                    for (let i = 0; i < periods.length - 1; i++) {
                        if (periods[i].day === periods[i + 1].day && periods[i].period + 1 === periods[i + 1].period) {
                            combinations.push([{day: periods[i].day, periods: [periods[i].period, periods[i + 1].period]}]);
                        }
                    }
                }
                const singleCombinations = [];
                const combineSingle = (start, current) => {
                    if (current.length === 2) {
                        singleCombinations.push(current.map(p => ({day: p.day, periods: [p.period]})));
                        return;
                    }
                    for (let i = start; i < periods.length; i++) {
                        combineSingle(i + 1, [...current, periods[i]]);
                    }
                };
                combineSingle(0, []);
                combinations.push(...singleCombinations);
            }

            return combinations;
        }

        function findTeacherRow(teacher) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            for (let row = 5; row <= range.e.r; row++) {
                const cell = sheet[XLSX.utils.encode_cell({c: 1, r: row})];
                if (cell && cell.v === teacher) {
                    return row;
                }
            }
            return -1;
        }

        function getColumnForDayAndPeriod(day, period) {
            const dayOffset = (day - 1) * 10;
            return 2 + dayOffset + period - 1;
        }

        function formatPeriods(periods) {
            if (periods.length === 1) {
                return `第${periods[0]}節`;
            } else if (periods.length === 2 && periods[0] + 1 === periods[1]) {
                return `第${periods[0]}至${periods[1]}節`;
            } else {
                return periods.map(p => `第${p}節`).join(', ');
            }
        }

        function displayResult(borrowDetails, availableCombinations, borrowTeacher, lendTeacher, className) {
            const resultDiv = document.getElementById('result');
            let html = '<h2>調堂詳情：</h2><table><tr><th>借出老師</th><th>班別</th><th>借出上課日</th><th>借出課節</th><th class="double-border">借入老師</th><th>歸還上課日</th><th>歸還課節</th></tr>';

            const borrowDay = borrowDetails[0].day;
            const borrowPeriods = borrowDetails.map(b => b.period).sort((a, b) => a - b);
            const borrowPeriodStr = formatPeriods(borrowPeriods);

            availableCombinations.forEach(comb => {
                let availDayStr = '';
                let availPeriodStr = '';
                if (comb.length === 1 && comb[0].periods.length === 2) {
                    availDayStr = `DAY${comb[0].day}`;
                    availPeriodStr = formatPeriods(comb[0].periods);
                } else {
                    availDayStr = comb.map(c => `DAY${c.day}`).join(', ');
                    availPeriodStr = comb.map(c => formatPeriods(c.periods)).join(', ');
                }
                if (!(availDayStr === `DAY${borrowDay}` && availPeriodStr === borrowPeriodStr)) {
                    html += `<tr><td>${lendTeacher}</td><td>${className}</td><td>DAY${borrowDay}</td><td>${borrowPeriodStr}</td><td class="double-border">${borrowTeacher}</td><td>${availDayStr}</td><td>${availPeriodStr}</td></tr>`;
                }
            });

            html += '</table>';
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
